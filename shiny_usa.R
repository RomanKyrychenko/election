library(shiny)
library(ggplot2)
library(dplyr)
library(ggthemes)
library(leaflet)
library(plotly)

ui <-  fluidPage(
  h1("???????????? ?? ??????"),
  h2("?????????????????????? ??????????????????????"),
  sidebarPanel(
    plotOutput(outputId = "ist")
  ),
  mainPanel(tabsetPanel(
    tabPanel("??????????", plotlyOutput(outputId = "map")),
    tabPanel("???????????????? ????????????????????????", flowLayout( 
    sliderInput(inputId = "i1", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i2", "??????????", min = 0, max = 1, value = 0.5),         
    sliderInput(inputId = "i3", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i4", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i5", "????????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i6", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i7", "????????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i8", "?????????? ????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i9", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i10", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i11", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i12", "??????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i13", "????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i14", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i15", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i16", "??????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i17", "????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i18", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i19", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i20", "??????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i21", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i22", "????????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i23", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i24", "??????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i25", "??????????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i26", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i27", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i28", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i29", "????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i30", "?????? ??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i31", "?????? ????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i32", "?????? ??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i33", "?????? ????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i34", "???????????????? ????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i35", "???????????????? ????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i36", "??????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i37", "????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i38", "????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i39", "????????????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i40", "?????? ????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i41", "???????????????? ????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i42", "???????????????? ????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i43", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i44", "??????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i45", "??????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i46", "??????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i47", "??????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i48", "??????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i49", "?????????????? ??????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i50", "??????????????????", min = 0, max = 1, value = 0.5),
    sliderInput(inputId = "i51", "????????????????", min = 0, max = 1, value = 0.5)
  )
))))

server <- function(input, output) {
  output$ist <- renderPlot({
    total[1,2] <- total[1,2]+total[1,7]*(1-input$i1)
    total[1,3] <- total[1,3]+total[1,7]*input$i1
    total[2,2] <- total[2,2]+total[2,7]*(1-input$i2)
    total[2,3] <- total[2,3]+total[2,7]*input$i2
    total[3,2] <- total[3,2]+total[3,7]*(1-input$i3)
    total[3,3] <- total[3,3]+total[3,7]*input$i3
    total[4,2] <- total[4,2]+total[4,7]*(1-input$i4)
    total[4,3] <- total[4,3]+total[4,7]*input$i4
    total[5,2] <- total[5,2]+total[5,7]*(1-input$i5)
    total[5,3] <- total[5,3]+total[5,7]*input$i5
    total[6,2] <- total[6,2]+total[6,7]*(1-input$i6)
    total[6,3] <- total[6,3]+total[6,7]*input$i6
    total[7,2] <- total[7,2]+total[7,7]*(1-input$i7)
    total[7,3] <- total[7,3]+total[7,7]*input$i7
    total[8,2] <- total[8,2]+total[8,7]*(1-input$i8)
    total[8,3] <- total[8,3]+total[8,7]*input$i8
    total[9,2] <- total[9,2]+total[9,7]*(1-input$i9)
    total[9,3] <- total[9,3]+total[9,7]*input$i9
    total[10,2] <- total[10,2]+total[10,7]*(1-input$i10)
    total[10,3] <- total[10,3]+total[10,7]*input$i10
    total[11,2] <- total[11,2]+total[11,7]*(1-input$i11)
    total[11,3] <- total[11,3]+total[11,7]*input$i11
    total[12,2] <- total[12,2]+total[12,7]*(1-input$i12)
    total[12,3] <- total[12,3]+total[12,7]*input$i12
    total[13,2] <- total[13,2]+total[13,7]*(1-input$i13)
    total[13,3] <- total[13,3]+total[13,7]*input$i13
    total[14,2] <- total[14,2]+total[14,7]*(1-input$i14)
    total[14,3] <- total[14,3]+total[14,7]*input$i14
    total[15,2] <- total[15,2]+total[15,7]*(1-input$i15)
    total[15,3] <- total[15,3]+total[15,7]*input$i15
    total[16,2] <- total[16,2]+total[16,7]*(1-input$i16)
    total[16,3] <- total[16,3]+total[16,7]*input$i16
    total[17,2] <- total[17,2]+total[17,7]*(1-input$i17)
    total[17,3] <- total[17,3]+total[17,7]*input$i17
    total[18,2] <- total[18,2]+total[18,7]*(1-input$i18)
    total[18,3] <- total[18,3]+total[18,7]*input$i18
    total[19,2] <- total[19,2]+total[19,7]*(1-input$i19)
    total[19,3] <- total[19,3]+total[19,7]*input$i19
    total[20,2] <- total[20,2]+total[20,7]*(1-input$i20)
    total[20,3] <- total[20,3]+total[20,7]*input$i20
    total[21,2] <- total[21,2]+total[21,7]*(1-input$i21)
    total[21,3] <- total[21,3]+total[21,7]*input$i21
    total[22,2] <- total[22,2]+total[22,7]*(1-input$i22)
    total[22,3] <- total[22,3]+total[22,7]*input$i22
    total[23,2] <- total[23,2]+total[23,7]*(1-input$i23)
    total[23,3] <- total[23,3]+total[23,7]*input$i23
    total[24,2] <- total[24,2]+total[24,7]*(1-input$i24)
    total[24,3] <- total[24,3]+total[24,7]*input$i24
    total[25,2] <- total[25,2]+total[25,7]*(1-input$i25)
    total[25,3] <- total[25,3]+total[25,7]*input$i25
    total[26,2] <- total[26,2]+total[26,7]*(1-input$i26)
    total[26,3] <- total[26,3]+total[26,7]*input$i26
    total[27,2] <- total[27,2]+total[27,7]*(1-input$i27)
    total[27,3] <- total[27,3]+total[27,7]*input$i27
    total[28,2] <- total[28,2]+total[28,7]*(1-input$i28)
    total[28,3] <- total[28,3]+total[28,7]*input$i28
    total[29,2] <- total[29,2]+total[29,7]*(1-input$i29)
    total[29,3] <- total[29,3]+total[29,7]*input$i29
    total[30,2] <- total[30,2]+total[30,7]*(1-input$i30)
    total[30,3] <- total[30,3]+total[30,7]*input$i30
    total[31,2] <- total[31,2]+total[31,7]*(1-input$i31)
    total[31,3] <- total[31,3]+total[31,7]*input$i31
    total[32,2] <- total[32,2]+total[32,7]*(1-input$i32)
    total[32,3] <- total[32,3]+total[32,7]*input$i32
    total[33,2] <- total[33,2]+total[33,7]*(1-input$i33)
    total[33,3] <- total[33,3]+total[33,7]*input$i33
    total[34,2] <- total[34,2]+total[34,7]*(1-input$i34)
    total[34,3] <- total[34,3]+total[34,7]*input$i34
    total[35,2] <- total[35,2]+total[35,7]*(1-input$i35)
    total[35,3] <- total[35,3]+total[35,7]*input$i35
    total[36,2] <- total[36,2]+total[36,7]*(1-input$i36)
    total[36,3] <- total[36,3]+total[36,7]*input$i36
    total[37,2] <- total[37,2]+total[37,7]*(1-input$i37)
    total[37,3] <- total[37,3]+total[37,7]*input$i37
    total[38,2] <- total[38,2]+total[38,7]*(1-input$i38)
    total[38,3] <- total[38,3]+total[38,7]*input$i38
    total[39,2] <- total[39,2]+total[39,7]*(1-input$i39)
    total[39,3] <- total[39,3]+total[39,7]*input$i39
    total[40,2] <- total[40,2]+total[40,7]*(1-input$i40)
    total[40,3] <- total[40,3]+total[40,7]*input$i40
    total[41,2] <- total[41,2]+total[41,7]*(1-input$i41)
    total[41,3] <- total[41,3]+total[41,7]*input$i41
    total[42,2] <- total[42,2]+total[42,7]*(1-input$i42)
    total[42,3] <- total[42,3]+total[42,7]*input$i42
    total[43,2] <- total[43,2]+total[43,7]*(1-input$i43)
    total[43,3] <- total[43,3]+total[43,7]*input$i43
    total[44,2] <- total[44,2]+total[44,7]*(1-input$i44)
    total[44,3] <- total[44,3]+total[44,7]*input$i44
    total[45,2] <- total[45,2]+total[45,7]*(1-input$i45)
    total[45,3] <- total[45,3]+total[45,7]*input$i45
    total[46,2] <- total[46,2]+total[46,7]*(1-input$i46)
    total[46,3] <- total[46,3]+total[46,7]*input$i46
    total[47,2] <- total[47,2]+total[47,7]*(1-input$i47)
    total[47,3] <- total[47,3]+total[47,7]*input$i47
    total[48,2] <- total[48,2]+total[48,7]*(1-input$i48)
    total[48,3] <- total[48,3]+total[48,7]*input$i48
    total[49,2] <- total[49,2]+total[49,7]*(1-input$i49)
    total[49,3] <- total[49,3]+total[49,7]*input$i49
    total[50,2] <- total[50,2]+total[50,7]*(1-input$i50)
    total[50,3] <- total[50,3]+total[50,7]*input$i50
    total[51,2] <- total[51,2]+total[51,7]*(1-input$i51)
    total[51,3] <- total[51,3]+total[51,7]*input$i51
    
    model <- data_frame(Clinton=total$Clinton,Trump=total$Trump,votes=total$votes)
    model <- mutate(model, "????????????????" = ifelse(Trump>Clinton, "?????????????? ??????????", "???????????? ??????????????"))
    vote <- model %>%
      group_by(????????????????) %>%
      summarise("???????? ??????????????" = round(sum(votes),0))
    ggplot(vote, aes(`????????????????`, `???????? ??????????????`)) + geom_bar(stat = "identity") + 
      geom_text(aes(label=`???????? ??????????????`), vjust=1.5, colour="white", position=position_dodge(.9), size=14) + theme_fivethirtyeight()
  })
  output$map <- renderPlotly({
    plot_ly(total, z = Clinton, text = hover, locations = code, type = 'choropleth',
            locationmode = 'USA-states', color = Clinton, colors = 'Purples',
            marker = list(line = l), colorbar = list(title = "?????????????????? ??????????????")) %>%
      layout(title = '???????????????? ???????????????????????? ??????????????', geo = g)
  })
}


shinyApp(ui = ui, server = server)


model <- data_frame(Clinton=total$Clinton+total$Undecided*(1-input$i),Trump=total$Trump+total$Undecided*input$i,votes=total$votes)


total$hover <- with(total, paste(State, '<br>', "??????????????", Clinton,'<br>', "??????????", Trump, '<br>',"??????????????",Johnson,'<br>',"??????????",Stein,'<br>',"???? ??????????????????????/????????", Undecided))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

plot_ly(total, z = Clinton, text = hover, locations = code, type = 'choropleth',
        locationmode = 'USA-states', color = Clinton, colors = 'Purples',
        marker = list(line = l), colorbar = list(title = "?????????????????? ??????????????")) %>%
  layout(title = '???????????????? ???????????????????????? ??????????????', geo = g)




output$map <- renderLeaflet({
  leaflet() %>%
    addTiles(
      urlTemplate = "//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png",
      attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>'
    ) %>%
    setView(lng = -93.85, lat = 37.45, zoom = 4)
})